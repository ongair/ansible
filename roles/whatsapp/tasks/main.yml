- include_vars: variables.yml

- name: Init virtualenv
  sudo: yes
  command: virtualenv --clear {{ virtualenv_directory }} -p {{ python_path }}

- name: Install pkutils
  sudo: yes
  pip: name=pkutils virtualenv={{ virtualenv_directory }}

- name: Install Ongair via PIP
  sudo: yes
  pip: name=ongair-whatsapp virtualenv={{ virtualenv_directory }} state=latest

- name: Install Ongair upstart configuration file.
  sudo: yes
  template: src=ongair-conf.j2 
        dest=/etc/init/{{item.agent_name}}.conf 
        mode=755 
  with_items: "{{agents}}"
  
- name: Install monitor log file
  file: path={{project_directory}}logs/monitoring.log state=touch owner={{deploy_user}}

- name: Install cron task
  cron: name='Monitor Ongair' minute="*/10" job="sudo {{virtualenv_directory}}bin/ongair-monitor-cli >> {{project_directory}}logs/monitoring.log"

- name: Copy Script to restart services into the server
  sudo: yes
  copy: src=restart-services.py 
        dest=/opt/restart-services.py 
        owner={{ deploy_user }} 
        group={{ deploy_user }} mode=755

- name: Restart existing ongair agents via a shell script
  command: /opt/restart-services.py